<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Relatórios</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin:20px; background:#f4f4f4; }
        h1 { color:#0056b3; }
        .cards { display:flex; gap:15px; margin-bottom:20px; }
        .card { flex:1; background:#fff; padding:15px; border-radius:8px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1 ); text-align:center; }
        .card.active { border:2px solid #0056b3; }
        .form-section { display:none; background:#fff; padding:20px; border-radius:8px; }
        .form-section.active { display:block; }
        
        /* NOVO ESTILO - CAIXAS LADO A LADO */
        .caixas-superiores {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .caixa-superior {
            flex: 1;
            min-width: 200px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #ddd;
            transition: all 0.3s ease;
        }
        .caixa-superior:hover {
            border-color: #0056b3;
        }
        .caixa-superior.selecionada {
            border-color: #0056b3;
            background-color: #f8f9fa;
        }
        .caixa-titulo {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .conteudo-caixa {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .caixa-superior.selecionada .conteudo-caixa {
            display: block;
        }
        
        /* Estilo para mostrar seleções anteriores */
        .resumo-selecao {
            font-size: 12px;
            color: #333;
            margin-top: 5px;
            font-weight: normal;
            background: #f0f8ff;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #0056b3;
        }
        .resumo-dados {
            margin: 2px 0;
            line-height: 1.3;
        }
        .resumo-titulo {
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 3px;
        }
        
        /* FIM DO NOVO ESTILO */

        label { font-weight:bold; margin-top:10px; display:block; }
        input, select { width:100%; padding:8px; margin-top:5px; box-sizing: border-box; }
        table { width:100%; border-collapse:collapse; margin-top:15px; }
        table, th, td { border:1px solid #ccc; }
        th, td { padding:5px; text-align:center; }
        .btn { background:#0056b3; color:#fff; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; margin-top:10px; }
        .hidden { display: none !important; }
        .form-group { display: block; margin-top: 10px; }
        .form-group label { font-weight: bold; margin: 0; display: flex; align-items: center; gap: 8px; }
        .form-group input[type="checkbox"] { margin: 0; width: 18px; height: 18px; }
        .contador-info { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; background-color: #f9f9f9; }
        .contador-info p { margin: 5px 0; }
        .total-row { font-weight: bold; background-color: #d9e1f2 !important; }
        th { background-color: #0056b3; color: white; font-weight: bold; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .fixed-logo { 
            position: fixed; 
            right: 20px; 
            top: 20px; 
            background: white; 
            padding: 10px; 
            border-radius: 5px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            text-align: center;
            z-index: 1000;
        }
        .fixed-logo img { 
            max-width: 150px; 
            max-height: 70px; 
            margin-bottom: 5px;
        }
        .fixed-logo p {
            margin: 0;
            font-weight: bold;
            color: #0056b3;
            font-size: 14px;
        }
        .param-group {
            margin-bottom: 10px;
        }
        .param-group label {
            font-weight: normal;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

    <h1> GERADOR DE RELAÇÃO DE FATURAMENTO</h1>
    <div class="cards">
        <div class="card active" onclick="abrirAba(0)">Relatório de Faturamento Real</div>
        <div class="card" onclick="abrirAba(1)">Relatório de Faturamento Simulado</div>
        <div class="card" onclick="abrirAba(2)">Relatório de Não Faturamento</div>
        <div class="card" onclick="abrirAba(3)">Previsão de Fatura</div>
    </div>

    <div class="form-section active" id="aba1">
        <h2>Relatório de Faturamento Real</h2>
        
        <div class="caixas-superiores">
            <div class="caixa-superior" onclick="selecionarCaixa(this, 'assinatura1')">
                <div class="caixa-titulo">Quem vai assinar:</div>
                <div id="resumo-assinatura1" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <select id="assinatura1" onchange="atualizarResumoAssinatura('1')">
                        <option value="">Selecione...</option>
                        <option value="Cliente">Cliente</option>
                        <option value="Contador">Contador</option>
                        <option value="Ambos">Cliente e Contador</option>
                    </select>
                    <div class="form-group" id="bloco-contador1" style="display:none;">
                        <label>Dados do contador:</label>
                        <div class="contador-info">
                            <p id="nomeContador1">THIAGO VIEIRA DOS SANTOS</p>
                            <p id="crcContador1">Contador CRC-TO: 004845-O</p>
                            <p id="crcEstados1">CRC Ativo nos Estados: TO/PA/PI/MA/GO/SP/RJ/PR/SC</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="caixa-superior" id="caixa-representante1" style="display:none;" onclick="selecionarCaixa(this, 'representante1')">
                <div class="caixa-titulo">Deseja informar o representante legal?</div>
                <div id="resumo-representante1" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" onclick="toggleRepresentante(this,'rep-real')"> Sim, informar representante
                        </label>
                    </div>
                    <div id="rep-real" class="hidden" style="margin-bottom:10px;">
                        <input type="text" id="repNome1" placeholder="Nome do Representante" disabled oninput="atualizarResumoRepresentante('1')">
                        <input type="text" id="repCpf1" placeholder="CPF do Representante" oninput="formatarCPF(this)" disabled onchange="atualizarResumoRepresentante('1')">
                        <input type="text" id="repNacionalidade1" placeholder="Nacionalidade" disabled onchange="atualizarResumoRepresentante('1')">
                        <input type="text" id="repDataNascimento1" placeholder="Data de Nascimento (DD/MM/AAAA)" oninput="formatarDataNascimento(this)" disabled onchange="atualizarResumoRepresentante('1')">
                        <input type="text" id="repRg1" placeholder="RG - Órgão emissor" disabled onchange="atualizarResumoRepresentante('1')">
                        <input type="text" id="repEndereco1" placeholder="Endereço - Logradouro/CEP" disabled onchange="atualizarResumoRepresentante('1')">
                        <input type="text" id="repEstadoCivil1" placeholder="Estado Civil" disabled onchange="atualizarResumoRepresentante('1')">
                        <input type="text" id="repProfissao1" placeholder="Profissão" disabled onchange="atualizarResumoRepresentante('1')">
                    </div>
                </div>
            </div>

            <div class="caixa-superior" onclick="selecionarCaixa(this, 'cnpj1')">
                <div class="caixa-titulo">CNPJ da Empresa</div>
                <div id="resumo-cnpj1" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <input type="text" id="cnpj1" placeholder="00.000.000/0000-00" oninput="formatarCNPJ(this)" onblur="buscarCNPJ(this.value, 'dadosEmpresa1'); atualizarResumoCNPJ('1')">
                    <div id="dadosEmpresa1" data-razao-social="" data-endereco=""></div>
                </div>
            </div>

            <div class="caixa-superior" onclick="selecionarCaixa(this, 'periodo1')">
                <div class="caixa-titulo">Período</div>
                <div id="resumo-periodo1" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <input type="month" id="inicio1" onchange="atualizarResumoPeriodo('1')"> até <input type="month" id="fim1" onchange="atualizarResumoPeriodo('1')">
                </div>
            </div>
        </div>

        <button class="btn" onclick="gerarTabela('inicio1','fim1','tabela1')">Gerar Tabela</button>
        <table id="tabela1">
            <thead><tr><th>Mês/Ano</th><th>Valores</th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn" onclick="gerarPDF1()">Exportar para PDF</button>
    </div>

    <div class="form-section" id="aba2">
        <h2>Relatório de Simulação de Faturamento</h2>
        
        <div class="caixas-superiores">
            <div class="caixa-superior" onclick="selecionarCaixa(this, 'assinatura2')">
                <div class="caixa-titulo">Quem vai assinar:</div>
                <div id="resumo-assinatura2" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <select id="assinatura2" onchange="atualizarResumoAssinatura('2')">
                        <option value="">Selecione...</option>
                        <option value="Cliente">Cliente</option>
                        <option value="Contador">Contador</option>
                        <option value="Ambos">Cliente e Contador</option>
                    </select>
                    <div class="form-group" id="bloco-contador2" style="display:none;">
                        <label>Dados do contador:</label>
                        <div class="contador-info">
                            <p id="nomeContador2">THIAGO VIEIRA DOS SANTOS</p>
                            <p id="crcContador2">Contador CRC-TO: 004845-O</p>
                            <p id="crcEstados2">CRC Ativo nos Estados: TO/PA/PI/MA/GO/SP/RJ/PR/SC</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="caixa-superior" id="caixa-representante2" style="display:none;" onclick="selecionarCaixa(this, 'representante2')">
                <div class="caixa-titulo">Deseja informar o representante legal?</div>
                <div id="resumo-representante2" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" onclick="toggleRepresentante(this,'rep-sim')"> Sim, informar representante
                        </label>
                    </div>
                    <div id="rep-sim" class="hidden" style="margin-bottom:10px;">
                        <input type="text" id="repNome2" placeholder="Nome do Representante" disabled oninput="atualizarResumoRepresentante('2')">
                        <input type="text" id="repCpf2" placeholder="CPF do Representante" oninput="formatarCPF(this)" disabled onchange="atualizarResumoRepresentante('2')">
                        <input type="text" id="repNacionalidade2" placeholder="Nacionalidade" disabled onchange="atualizarResumoRepresentante('2')">
                        <input type="text" id="repDataNascimento2" placeholder="Data de Nascimento (DD/MM/AAAA)" oninput="formatarDataNascimento(this)" disabled onchange="atualizarResumoRepresentante('2')">
                        <input type="text" id="repRg2" placeholder="RG - Órgão emissor" disabled onchange="atualizarResumoRepresentante('2')">
                        <input type="text" id="repEndereco2" placeholder="Endereço - Logradouro/CEP" disabled onchange="atualizarResumoRepresentante('2')">
                        <input type="text" id="repEstadoCivil2" placeholder="Estado Civil" disabled onchange="atualizarResumoRepresentante('2')">
                        <input type="text" id="repProfissao2" placeholder="Profissão" disabled onchange="atualizarResumoRepresentante('2')">
                    </div>
                </div>
            </div>

            <div class="caixa-superior" onclick="selecionarCaixa(this, 'cnpj2')">
                <div class="caixa-titulo">CNPJ da Empresa</div>
                <div id="resumo-cnpj2" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <input type="text" id="cnpj2" placeholder="00.000.000/0000-00" oninput="formatarCNPJ(this)" onblur="buscarCNPJ(this.value, 'dadosEmpresa2'); atualizarResumoCNPJ('2')">
                    <div id="dadosEmpresa2" data-razao-social="" data-endereco=""></div>
                </div>
            </div>

            <div class="caixa-superior" onclick="selecionarCaixa(this, 'periodo2')">
                <div class="caixa-titulo">Período</div>
                <div id="resumo-periodo2" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <input type="month" id="inicio2" onchange="atualizarResumoPeriodo('2')"> até <input type="month" id="fim2" onchange="atualizarResumoPeriodo('2')">
                </div>
            </div>
        </div>

        <button class="btn" onclick="gerarTabela('inicio2','fim2','tabela2')">Gerar Tabela</button>
        <label>Forma de cálculo</label>
        <select id="calculo2" onchange="configurarCalculo()">
            <option value="livre">Digitação Livre</option>
            <option value="media">Média por Total</option>
            <option value="aleatorio">Aleatórios Crescentes</option>
            <option value="valorAlvo">Valor Alvo</option>
        </select>
        <div id="parametrosCalculo" style="margin-top:10px;"></div>
        <table id="tabela2">
            <thead><tr><th>Mês/Ano</th><th>Valores</th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn" onclick="gerarPDF2()">Exportar para PDF</button>
    </div>

    <div class="form-section" id="aba3">
        <h2>Relatório de Não Faturamento</h2>
        
        <div class="caixas-superiores">
            <div class="caixa-superior" onclick="selecionarCaixa(this, 'assinatura3')">
                <div class="caixa-titulo">Quem vai assinar:</div>
                <div id="resumo-assinatura3" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <select id="assinatura3" onchange="atualizarResumoAssinatura('3')">
                        <option value="">Selecione...</option>
                        <option value="Cliente">Cliente</option>
                        <option value="Contador">Contador</option>
                        <option value="Ambos">Cliente e Contador</option>
                    </select>
                    <div class="form-group" id="bloco-contador3" style="display:none;">
                        <label>Dados do contador:</label>
                        <div class="contador-info">
                            <p id="nomeContador3">THIAGO VIEIRA DOS SANTOS</p>
                            <p id="crcContador3">Contador CRC-TO: 004845-O</p>
                            <p id="crcEstados3">CRC Ativo nos Estados: TO/PA/PI/MA/GO/SP/RJ/PR/SC</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="caixa-superior" id="caixa-representante3" style="display:none;" onclick="selecionarCaixa(this, 'representante3')">
                <div class="caixa-titulo">Deseja informar o representante legal?</div>
                <div id="resumo-representante3" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" onclick="toggleRepresentante(this,'rep-nao')"> Sim, informar representante
                        </label>
                    </div>
                    <div id="rep-nao" class="hidden" style="margin-bottom:10px;">
                        <input type="text" id="repNome3" placeholder="Nome do Representante" disabled oninput="atualizarResumoRepresentante('3')">
                        <input type="text" id="repCpf3" placeholder="CPF do Representante" oninput="formatarCPF(this)" disabled onchange="atualizarResumoRepresentante('3')">
                        <input type="text" id="repNacionalidade3" placeholder="Nacionalidade" disabled onchange="atualizarResumoRepresentante('3')">
                        <input type="text" id="repDataNascimento3" placeholder="Data de Nascimento (DD/MM/AAAA)" oninput="formatarDataNascimento(this)" disabled onchange="atualizarResumoRepresentante('3')">
                        <input type="text" id="repRg3" placeholder="RG - Órgão emissor" disabled onchange="atualizarResumoRepresentante('3')">
                        <input type="text" id="repEndereco3" placeholder="Endereço - Logradouro/CEP" disabled onchange="atualizarResumoRepresentante('3')">
                        <input type="text" id="repEstadoCivil3" placeholder="Estado Civil" disabled onchange="atualizarResumoRepresentante('3')">
                        <input type="text" id="repProfissao3" placeholder="Profissão" disabled onchange="atualizarResumoRepresentante('3')">
                    </div>
                </div>
            </div>

            <div class="caixa-superior" onclick="selecionarCaixa(this, 'cnpj3')">
                <div class="caixa-titulo">CNPJ da Empresa</div>
                <div id="resumo-cnpj3" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <input type="text" id="cnpj3" placeholder="00.000.000/0000-00" oninput="formatarCNPJ(this)" onblur="buscarCNPJ(this.value, 'dadosEmpresa3'); atualizarResumoCNPJ('3')">
                    <div id="dadosEmpresa3" data-razao-social="" data-endereco=""></div>
                </div>
            </div>

            <div class="caixa-superior" onclick="selecionarCaixa(this, 'periodo3')">
                <div class="caixa-titulo">Período</div>
                <div id="resumo-periodo3" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <input type="month" id="inicio3" onchange="atualizarResumoPeriodo('3')"> até <input type="month" id="fim3" onchange="atualizarResumoPeriodo('3')">
                </div>
            </div>
        </div>

        <div id="mensagem3" style="margin-top:15px; font-style:italic;">
            No período selecionado não houve faturamento.
        </div>
        <button class="btn" onclick="gerarPDF3()">Exportar para PDF</button>
    </div>

    <div class="form-section" id="aba4">
        <h2>Previsão de Fatura</h2>
        
        <div class="caixas-superiores">
            <div class="caixa-superior" onclick="selecionarCaixa(this, 'assinatura4')">
                <div class="caixa-titulo">Quem vai assinar:</div>
                <div id="resumo-assinatura4" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <select id="assinatura4" onchange="atualizarResumoAssinatura('4')">
                        <option value="">Selecione...</option>
                        <option value="Cliente">Cliente</option>
                        <option value="Contador">Contador</option>
                        <option value="Ambos">Cliente e Contador</option>
                    </select>
                    <div class="form-group" id="bloco-contador4" style="display:none;">
                        <label>Dados do contador:</label>
                        <div class="contador-info">
                            <p id="nomeContador4">THIAGO VIEIRA DOS SANTOS</p>
                            <p id="crcContador4">Contador CRC-TO: 004845-O</p>
                            <p id="crcEstados4">CRC Ativo nos Estados: TO/PA/PI/MA/GO/SP/RJ/PR/SC</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="caixa-superior" id="caixa-representante4" style="display:none;" onclick="selecionarCaixa(this, 'representante4')">
                <div class="caixa-titulo">Deseja informar o representante legal?</div>
                <div id="resumo-representante4" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" onclick="toggleRepresentante(this,'rep-prev')"> Sim, informar representante
                        </label>
                    </div>
                    <div id="rep-prev" class="hidden" style="margin-bottom:10px;">
                        <input type="text" id="repNome4" placeholder="Nome do Representante" disabled oninput="atualizarResumoRepresentante('4')">
                        <input type="text" id="repCpf4" placeholder="CPF do Representante" oninput="formatarCPF(this)" disabled onchange="atualizarResumoRepresentante('4')">
                        <input type="text" id="repNacionalidade4" placeholder="Nacionalidade" disabled onchange="atualizarResumoRepresentante('4')">
                        <input type="text" id="repDataNascimento4" placeholder="Data de Nascimento (DD/MM/AAAA)" oninput="formatarDataNascimento(this)" disabled onchange="atualizarResumoRepresentante('4')">
                        <input type="text" id="repRg4" placeholder="RG - Órgão emissor" disabled onchange="atualizarResumoRepresentante('4')">
                        <input type="text" id="repEndereco4" placeholder="Endereço - Logradouro/CEP" disabled onchange="atualizarResumoRepresentante('4')">
                        <input type="text" id="repEstadoCivil4" placeholder="Estado Civil" disabled onchange="atualizarResumoRepresentante('4')">
                        <input type="text" id="repProfissao4" placeholder="Profissão" disabled onchange="atualizarResumoRepresentante('4')">
                    </div>
                </div>
            </div>

            <div class="caixa-superior" onclick="selecionarCaixa(this, 'cnpj4')">
                <div class="caixa-titulo">CNPJ da Empresa</div>
                <div id="resumo-cnpj4" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <input type="text" id="cnpj4" placeholder="00.000.000/0000-00" oninput="formatarCNPJ(this)" onblur="buscarCNPJ(this.value, 'dadosEmpresa4'); atualizarResumoCNPJ('4')">
                    <div id="dadosEmpresa4" data-razao-social="" data-endereco=""></div>
                </div>
            </div>

            <div class="caixa-superior" onclick="selecionarCaixa(this, 'periodo4')">
                <div class="caixa-titulo">Período</div>
                <div id="resumo-periodo4" class="resumo-selecao"></div>
                <div class="conteudo-caixa">
                    <input type="month" id="inicio4" onchange="atualizarResumoPeriodo('4')"> até <input type="month" id="fim4" onchange="atualizarResumoPeriodo('4')">
                </div>
            </div>
        </div>

        <button class="btn" onclick="gerarTabela('inicio4','fim4','tabela4')">Gerar Tabela</button>
        <label>Forma de cálculo</label>
        <select id="calculo4" onchange="configurarCalculoPrevisao()">
            <option value="livre">Digitação Livre</option>
            <option value="media">Média por Total</option>
            <option value="aleatorio">Aleatórios Crescentes</option>
            <option value="valorAlvo">Valor Alvo</option>
        </select>
        <div id="parametrosCalculoPrevisao" style="margin-top:10px;"></div>
        <table id="tabela4">
            <thead><tr><th>Mês/Ano</th><th>Valores</th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn" onclick="gerarPDF4()">Exportar para PDF</button>
    </div>

    <script>
        function atualizarResumoAssinatura(aba) {
            const select = document.getElementById(`assinatura${aba}`);
            const resumo = document.getElementById(`resumo-assinatura${aba}`);
            const caixaRepresentante = document.getElementById(`caixa-representante${aba}`);
            
            let html = '';
            
            if (select.value) {
                html += `<div class="resumo-titulo">Selecionado: ${select.value}</div>`;
                
                if (select.value === 'Contador' || select.value === 'Ambos') {
                    html += `
                        <div class="resumo-dados"><strong>Contador:</strong> THIAGO VIEIRA DOS SANTOS</div>
                        <div class="resumo-dados"><strong>CRC:</strong> 004845-O</div>
                        <div class="resumo-dados"><strong>Estados:</strong> TO/PA/PI/MA/GO/SP/RJ/PR/SC</div>
                    `;
                }
                
                if (select.value === 'Cliente' || select.value === 'Ambos') {
                    const cnpj = document.getElementById(`cnpj${aba}`).value;
                    const dadosEmpresa = document.getElementById(`dadosEmpresa${aba}`);
                    if (cnpj || dadosEmpresa.dataset.razaoSocial) {
                        html += `<div class="resumo-titulo" style="margin-top: 5px;">Dados da Empresa:</div>`;
                        if (dadosEmpresa.dataset.razaoSocial) {
                            html += `<div class="resumo-dados"><strong>Razão Social:</strong> ${dadosEmpresa.dataset.razaoSocial}</div>`;
                        }
                        if (cnpj) {
                            html += `<div class="resumo-dados"><strong>CNPJ:</strong> ${cnpj}</div>`;
                        }
                    }
                }
            }
            
            resumo.innerHTML = html;
            
            if (select.value === 'Cliente' || select.value === 'Ambos') {
                caixaRepresentante.style.display = 'block';
            } else {
                caixaRepresentante.style.display = 'none';
            }
            
            document.getElementById(`bloco-contador${aba}`).style.display = 
                (select.value === 'Contador' || select.value === 'Ambos') ? 'block' : 'none';
        }

        function atualizarResumoRepresentante(aba) {
            const resumo = document.getElementById(`resumo-representante${aba}`);
            const checkbox = document.querySelector(`#caixa-representante${aba} input[type="checkbox"]`);
            const repNome = document.getElementById(`repNome${aba}`).value;
            const repCpf = document.getElementById(`repCpf${aba}`).value;
            const repNacionalidade = document.getElementById(`repNacionalidade${aba}`).value;
            const repDataNascimento = document.getElementById(`repDataNascimento${aba}`).value;
            const repRg = document.getElementById(`repRg${aba}`).value;
            const repEndereco = document.getElementById(`repEndereco${aba}`).value;
            const repEstadoCivil = document.getElementById(`repEstadoCivil${aba}`).value;
            const repProfissao = document.getElementById(`repProfissao${aba}`).value;
            
            let html = '';
            
            if (checkbox.checked) {
                html += `<div class="resumo-titulo">Representante Legal</div>`;
                
                if (repNome) html += `<div class="resumo-dados"><strong>Nome:</strong> ${repNome}</div>`;
                if (repCpf) html += `<div class="resumo-dados"><strong>CPF:</strong> ${repCpf}</div>`;
                if (repNacionalidade) html += `<div class="resumo-dados"><strong>Nacionalidade:</strong> ${repNacionalidade}</div>`;
                if (repDataNascimento) html += `<div class="resumo-dados"><strong>Data Nasc.:</strong> ${repDataNascimento}</div>`;
                if (repRg) html += `<div class="resumo-dados"><strong>RG:</strong> ${repRg}</div>`;
                if (repEndereco) html += `<div class="resumo-dados"><strong>Endereço:</strong> ${repEndereco}</div>`;
                if (repEstadoCivil) html += `<div class="resumo-dados"><strong>Estado Civil:</strong> ${repEstadoCivil}</div>`;
                if (repProfissao) html += `<div class="resumo-dados"><strong>Profissão:</strong> ${repProfissao}</div>`;
                
                if (!repNome && !repCpf) {
                    html += `<div class="resumo-dados">Representante habilitado - preencha os dados</div>`;
                }
            }
            
            resumo.innerHTML = html;
        }

        function atualizarResumoCNPJ(aba) {
            const cnpj = document.getElementById(`cnpj${aba}`).value;
            const resumo = document.getElementById(`resumo-cnpj${aba}`);
            const dadosEmpresa = document.getElementById(`dadosEmpresa${aba}`);
            
            let html = '';
            
            if (cnpj || dadosEmpresa.dataset.razaoSocial || dadosEmpresa.dataset.endereco) {
                html += `<div class="resumo-titulo">Dados da Empresa</div>`;
                
                if (dadosEmpresa.dataset.razaoSocial) {
                    html += `<div class="resumo-dados"><strong>Razão Social:</strong> ${dadosEmpresa.dataset.razaoSocial}</div>`;
                }
                if (cnpj) {
                    html += `<div class="resumo-dados"><strong>CNPJ:</strong> ${cnpj}</div>`;
                }
                if (dadosEmpresa.dataset.endereco) {
                    html += `<div class="resumo-dados"><strong>Endereço:</strong> ${dadosEmpresa.dataset.endereco}</div>`;
                }
            }
            
            resumo.innerHTML = html;
        }

        function atualizarResumoPeriodo(aba) {
            const inicio = document.getElementById(`inicio${aba}`).value;
            const fim = document.getElementById(`fim${aba}`).value;
            const resumo = document.getElementById(`resumo-periodo${aba}`);
            
            let html = '';
            
            if (inicio || fim) {
                html += `<div class="resumo-titulo">Período Selecionado</div>`;
                
                if (inicio && fim) {
                    html += `<div class="resumo-dados"><strong>De:</strong> ${formatarPeriodo(inicio)}</div>`;
                    html += `<div class="resumo-dados"><strong>Até:</strong> ${formatarPeriodo(fim)}</div>`;
                } else if (inicio) {
                    html += `<div class="resumo-dados"><strong>Início:</strong> ${formatarPeriodo(inicio)}</div>`;
                } else if (fim) {
                    html += `<div class="resumo-dados"><strong>Fim:</strong> ${formatarPeriodo(fim)}</div>`;
                }
            }
            
            resumo.innerHTML = html;
        }

        function selecionarCaixa(elemento, tipo) {
            const caixas = elemento.parentElement.querySelectorAll('.caixa-superior');
            caixas.forEach(caixa => {
                caixa.classList.remove('selecionada');
            });
            
            elemento.classList.add('selecionada');
        }

        const fixedLogoData = "";

        function formatarCPF(cpfInput) {
            let v = cpfInput.value.replace(/\D/g, '');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            cpfInput.value = v;
        }

        function formatarCNPJ(cnpjInput) {
            let v = cnpjInput.value.replace(/\D/g, '');
            v = v.replace(/^(\d{2})(\d)/, '$1.$2');
            v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            v = v.replace(/\.(\d{3})(\d)/, '.$1/$2');
            v = v.replace(/(\d{4})(\d)/, '$1-$2');
            cnpjInput.value = v;
        }

        function formatarDataNascimento(input) {
            let v = input.value.replace(/\D/g, '');
            if (v.length > 2) v = v.substring(0,2) + '/' + v.substring(2);
            if (v.length > 5) v = v.substring(0,5) + '/' + v.substring(5);
            input.value = v.substring(0, 10);
        }

        function formatarPeriodo(valor) {
            if (!valor) return "";
            let [ano, mes] = valor.split("-");
            mes = mes.padStart(2, "0");
            return `${mes}/${ano}`;
        }

        function formatarMoeda(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor === "") { input.value = ""; return; }
            valor = (parseInt(valor) / 100).toLocaleString("pt-BR", { 
                style: "currency", 
                currency: "BRL",
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            input.value = valor;
            if(input.id === 'valorTotalMedia' || input.id === 'valorAlvo' || input.id === 'valorMinimoInicial' || 
               input.id === 'valorTotalMediaPrev' || input.id === 'valorAlvoPrev' || input.id === 'valorMinimoInicialPrev') return;
            calcularTotais();
        }
    
        function parseMoeda(valor) {
            if (!valor) return 0;
            // Remove R$, espaços e pontos, troca vírgula por ponto e converte para número
            const numero = parseFloat(valor.replace(/[R$\s.]/g, "").replace(",", ".")) || 0;
            // Arredonda para 2 casas decimais para evitar problemas de precisão
            return Number(numero.toFixed(2));
        }

        function abrirAba(idx) {
            document.querySelectorAll('.card').forEach((c, i) => c.classList.toggle('active', i === idx));
            document.querySelectorAll('.form-section').forEach((s, i) => s.classList.toggle('active', i === idx));
            if (idx === 1) {
                configurarCalculo();
            } else if (idx === 3) {
                configurarCalculoPrevisao();
            }
        }

        function toggleRepresentante(checkbox, divId) {
            const div = document.getElementById(divId);
            div.classList.toggle('hidden', !checkbox.checked);
            div.querySelectorAll('input').forEach(inp => inp.disabled = !checkbox.checked);
            const aba = divId.split('-')[1] === 'real' ? '1' : 
                       divId.split('-')[1] === 'sim' ? '2' :
                       divId.split('-')[1] === 'nao' ? '3' : '4';
            atualizarResumoRepresentante(aba);
        }

        ['1', '2', '3', '4'].forEach(aba => {
            document.getElementById(`assinatura${aba}`).addEventListener('change', function() {
                atualizarResumoAssinatura(aba);
            });
        });

        async function buscarCNPJ(cnpj, idDiv) {
            const div = document.getElementById(idDiv);
            div.innerHTML = "Buscando...";
            div.dataset.razaoSocial = "";
            div.dataset.endereco = "";
            if (!cnpj) { div.innerHTML = ""; return; }
        
            cnpj = cnpj.replace(/\D/g, "");
            if (cnpj.length !== 14) { div.innerHTML = "CNPJ inválido."; return; }

            try {
                const r = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}` );
                if (!r.ok) throw new Error('Falha na busca');
                const d = await r.json();
                if (d.razao_social) {
                    const enderecoCompleto = `${d.logradouro}, Nº ${d.numero}, ${d.bairro}, ${d.municipio}/${d.uf}, CEP: ${d.cep}`;
                    div.dataset.razaoSocial = d.razao_social;
                    div.dataset.endereco = enderecoCompleto;
                    div.innerHTML = `<b>Razão Social:</b> ${d.razao_social}`;
                    const aba = idDiv.slice(-1);
                    atualizarResumoCNPJ(aba);
                    atualizarResumoAssinatura(aba);
                } else {
                    throw new Error('Resposta da API não contém razão social.');
                }
            } catch (e) {
                div.innerHTML = "Não foi possível buscar os dados.";
            }
        }

        function gerarTabela(idInicio, idFim, tabelaId) {
            const inicio = document.getElementById(idInicio).value;
            const fim = document.getElementById(idFim).value;
            const tbody = document.querySelector(`#${tabelaId} tbody`);
            tbody.innerHTML = "";
            if (!inicio || !fim) return;

            let [anoIni, mesIni] = inicio.split("-").map(Number);
            let [anoFim, mesFim] = fim.split("-").map(Number);

            while (anoIni < anoFim || (anoIni === anoFim && mesIni <= mesFim)) {
                let mesFormatado = String(mesIni).padStart(2, '0');
                tbody.innerHTML += `<tr><td>${mesFormatado}/${anoIni}</td><td><input type="text" oninput="formatarMoeda(this)"></td></tr>`;
                mesIni++;
                if (mesIni > 12) { mesIni = 1; anoIni++; }
            }
            
            tbody.innerHTML += `<tr class="total-row"><td><b>TOTAL:</b></td><td id="celulaTotal${tabelaId.slice(-1)}"><b>R$ 0,00</b></td></tr>`;
        }

        function calcularTotais() {
            ["tabela1", "tabela2", "tabela4"].forEach((tbl, idx) => {
                let soma = 0;
                document.querySelectorAll(`#${tbl} tbody tr:not(.total-row) input`).forEach(inp => {
                    soma += parseMoeda(inp.value);
                });
                
                const totalCell = document.getElementById(`celulaTotal${tbl.slice(-1)}`);
                if (totalCell) {
                    totalCell.innerHTML = `<b>${soma.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</b>`;
                }
            });
        }

        function configurarCalculo() {
            const tipo = document.getElementById("calculo2").value;
            const div = document.getElementById("parametrosCalculo");
            
            if (tipo === "aleatorio") {
                div.innerHTML = `
                    <div class="param-group">
                        <label>Valor Inicial</label>
                        <input type="text" id="valorInicial" oninput="formatarMoeda(this)">
                    </div>
                    <div class="param-group">
                        <label>Valor Final</label>
                        <input type="text" id="valorFinal" oninput="formatarMoeda(this)">
                    </div>
                    <button class="btn" onclick="gerarAleatorios()">Gerar Valores</button>`;
            } else if (tipo === "media") {
                div.innerHTML = `
                    <div class="param-group">
                        <label>Valor Total para Dividir</label>
                        <input type="text" id="valorTotalMedia" oninput="formatarMoeda(this)">
                    </div>
                    <button class="btn" onclick="gerarMedia()">Calcular Média</button>`;
            } else if (tipo === "valorAlvo") {
                div.innerHTML = `
                    <div class="param-group">
                        <label>Valor Alvo (Total a ser atingido)</label>
                        <input type="text" id="valorAlvo" oninput="formatarMoeda(this)">
                    </div>
                    <div class="param-group">
                        <label>Valor Mínimo Inicial</label>
                        <input type="text" id="valorMinimoInicial" oninput="formatarMoeda(this)" value="R$ 100,00">
                    </div>
                    <button class="btn" onclick="gerarValorAlvo()">Gerar Valores Crescentes</button>`;
            } else {
                div.innerHTML = "";
            }
        }

        function configurarCalculoPrevisao() {
            const tipo = document.getElementById("calculo4").value;
            const div = document.getElementById("parametrosCalculoPrevisao");
            
            if (tipo === "aleatorio") {
                div.innerHTML = `
                    <div class="param-group">
                        <label>Valor Inicial</label>
                        <input type="text" id="valorInicialPrev" oninput="formatarMoeda(this)">
                    </div>
                    <div class="param-group">
                        <label>Valor Final</label>
                        <input type="text" id="valorFinalPrev" oninput="formatarMoeda(this)">
                    </div>
                    <button class="btn" onclick="gerarAleatoriosPrevisao()">Gerar Valores</button>`;
            } else if (tipo === "media") {
                div.innerHTML = `
                    <div class="param-group">
                        <label>Valor Total para Dividir</label>
                        <input type="text" id="valorTotalMediaPrev" oninput="formatarMoeda(this)">
                    </div>
                    <button class="btn" onclick="gerarMediaPrevisao()">Calcular Média</button>`;
            } else if (tipo === "valorAlvo") {
                div.innerHTML = `
                    <div class="param-group">
                        <label>Valor Alvo (Total a ser atingido)</label>
                        <input type="text" id="valorAlvoPrev" oninput="formatarMoeda(this)">
                    </div>
                    <div class="param-group">
                        <label>Valor Mínimo Inicial</label>
                        <input type="text" id="valorMinimoInicialPrev" oninput="formatarMoeda(this)" value="R$ 100,00">
                    </div>
                    <button class="btn" onclick="gerarValorAlvoPrevisao()">Gerar Valores Crescentes</button>`;
            } else {
                div.innerHTML = "";
            }
        }

        function gerarAleatorios() {
            const ini = parseMoeda(document.getElementById("valorInicial").value);
            const fim = parseMoeda(document.getElementById("valorFinal").value);
            const linhas = document.querySelectorAll("#tabela2 tbody tr:not(.total-row)");
            if (linhas.length === 0) return;

            let passo = (fim - ini) / (linhas.length > 1 ? linhas.length - 1 : 1);
            linhas.forEach((tr, i) => {
                let valorBase = ini + i * passo;
                let aleatorio = (Math.random() * passo - (passo / 2)) * 0.1;
                let valorFinal = Math.max(0, valorBase + aleatorio);
                tr.querySelector("input").value = valorFinal.toLocaleString("pt-BR", { 
                    style: "currency", 
                    currency: "BRL",
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            });    
            calcularTotais();
        }

        function gerarAleatoriosPrevisao() {
            const ini = parseMoeda(document.getElementById("valorInicialPrev").value);
            const fim = parseMoeda(document.getElementById("valorFinalPrev").value);
            const linhas = document.querySelectorAll("#tabela4 tbody tr:not(.total-row)");
            if (linhas.length === 0) return;

            let passo = (fim - ini) / (linhas.length > 1 ? linhas.length - 1 : 1);
            linhas.forEach((tr, i) => {
                let valorBase = ini + i * passo;
                let aleatorio = (Math.random() * passo - (passo / 2)) * 0.1;
                let valorFinal = Math.max(0, valorBase + aleatorio);
                tr.querySelector("input").value = valorFinal.toLocaleString("pt-BR", { 
                    style: "currency", 
                    currency: "BRL",
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            });    
            calcularTotais();
        }

        function gerarMedia() {
            const total = parseMoeda(document.getElementById("valorTotalMedia").value);
            const linhas = document.querySelectorAll("#tabela2 tbody tr:not(.total-row)");
            if (linhas.length === 0) return;

            const media = total / linhas.length;
            linhas.forEach(tr => {
                tr.querySelector("input").value = media.toLocaleString("pt-BR", { 
                    style: "currency", 
                    currency: "BRL",
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            });
            calcularTotais();
        }

        function gerarMediaPrevisao() {
            const total = parseMoeda(document.getElementById("valorTotalMediaPrev").value);
            const linhas = document.querySelectorAll("#tabela4 tbody tr:not(.total-row)");
            if (linhas.length === 0) return;

            const media = total / linhas.length;
            linhas.forEach(tr => {
                tr.querySelector("input").value = media.toLocaleString("pt-BR", { 
                    style: "currency", 
                    currency: "BRL",
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            });
            calcularTotais();
        }

        function gerarValorAlvo() {
            const valorAlvo = parseMoeda(document.getElementById("valorAlvo").value);
            const valorMinimo = parseMoeda(document.getElementById("valorMinimoInicial").value) || 100;
            const linhas = document.querySelectorAll("#tabela2 tbody tr:not(.total-row)");
            
            if (linhas.length === 0 || valorAlvo <= 0) {
                alert("Por favor, gere a tabela primeiro e informe um valor alvo válido.");
                return;
            }

            if (valorAlvo < valorMinimo * linhas.length) {
                alert(`O valor alvo é muito baixo para o número de meses. Mínimo necessário: R$ ${(valorMinimo * linhas.length).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
                return;
            }

            const valores = gerarValoresCrescentes(valorAlvo, linhas.length, valorMinimo);
            
            linhas.forEach((tr, i) => {
                tr.querySelector("input").value = valores[i].toLocaleString("pt-BR", { 
                    style: "currency", 
                    currency: "BRL",
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            });
            
            calcularTotais();
        }

        function gerarValorAlvoPrevisao() {
            const valorAlvo = parseMoeda(document.getElementById("valorAlvoPrev").value);
            const valorMinimo = parseMoeda(document.getElementById("valorMinimoInicialPrev").value) || 100;
            const linhas = document.querySelectorAll("#tabela4 tbody tr:not(.total-row)");
            
            if (linhas.length === 0 || valorAlvo <= 0) {
                alert("Por favor, gere a tabela primeiro e informe um valor alvo válido.");
                return;
            }

            if (valorAlvo < valorMinimo * linhas.length) {
                alert(`O valor alvo é muito baixo para o número de meses. Mínimo necessário: R$ ${(valorMinimo * linhas.length).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`);
                return;
            }

            const valores = gerarValoresCrescentes(valorAlvo, linhas.length, valorMinimo);
            
            linhas.forEach((tr, i) => {
                tr.querySelector("input").value = valores[i].toLocaleString("pt-BR", { 
                    style: "currency", 
                    currency: "BRL",
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            });
            
            calcularTotais();
        }

        function gerarValoresCrescentes(total, quantidade, valorInicial) {
            // Converte e valida
            total = Number(total);
            quantidade = Number(quantidade);
            valorInicial = Number(valorInicial);

            if (!isFinite(total) || !isFinite(quantidade) || !isFinite(valorInicial)) return [];
            if (quantidade <= 0 || total <= 0 || valorInicial <= 0) return [];

            // Caso simples: 1 mês
            if (quantidade === 1) return [Number(total.toFixed(2))];

            // Se o total for menor que o primeiro valor informado vezes quantidade,
            // não é possível criar uma sequência crescente com esse primeiro valor.
            // Nesses casos, distribuímos igualmente.
            if (total < valorInicial * quantidade) {
                const valorMedio = Number((total / quantidade).toFixed(2));
                return Array.from({ length: quantidade }, () => valorMedio);
            }

            // Usa progressão aritmética (a_n = a1 + (n-1)*d)
            // Soma S = n/2 * (2*a1 + (n-1)*d) -> resolve d
            const n = quantidade;
            const a1 = valorInicial;
            const S = total;
            const d = (2 * S / n - 2 * a1) / (n - 1);

            // Se d for negativo (improvável aqui), fallback para incremento linear não-negativo
            const dFinal = d > 0 ? d : 0;

            const valores = [];
            for (let i = 0; i < n; i++) {
                const ai = a1 + i * dFinal;
                valores.push(Number(ai.toFixed(2)));
            }

            // Ajuste por arredondamento: corrige diferença no último elemento
            const soma = valores.reduce((a, b) => a + b, 0);
            const diferenca = Number((S - soma).toFixed(2));
            if (Math.abs(diferenca) >= 0.01) {
                valores[valores.length - 1] = Number((valores[valores.length - 1] + diferenca).toFixed(2));
            }

            // Garante crescente (por segurança)
            for (let i = 1; i < valores.length; i++) {
                if (valores[i] <= valores[i - 1]) {
                    valores[i] = Number((valores[i - 1] + 0.01).toFixed(2));
                }
            }

            return valores;
        }

        function drawFormattedText(doc, text, x, y, maxWidth) {
            const boldRegex = /\*\*(.*?)\*\*/g;
            let lastIndex = 0;
            let match;
            let currentX = x;

            while ((match = boldRegex.exec(text)) !== null) {
                const normalText = text.substring(lastIndex, match.index);
                if (normalText) {
                    doc.setFont("helvetica", "normal");
                    doc.text(normalText, currentX, y);
                    currentX += doc.getStringUnitWidth(normalText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                }

                const boldText = match[1];
                doc.setFont("helvetica", "bold");
                doc.text(boldText, currentX, y);
                currentX += doc.getStringUnitWidth(boldText) * doc.internal.getFontSize() / doc.internal.scaleFactor;

                lastIndex = boldRegex.lastIndex;
            }

            const remainingText = text.substring(lastIndex);
            if (remainingText) {
                doc.setFont("helvetica", "normal");
                doc.text(remainingText, currentX, y);
            }
        }

        function addFixedLogoToPDF(doc, startY) {
            try {
                const imgProps = doc.getImageProperties(fixedLogoData);
                const logoWidth = 40;
                const logoHeight = (imgProps.height * logoWidth) / imgProps.width;
                
                const pageWidth = doc.internal.pageSize.width;
                const rightMargin = 10;
                const logoX = pageWidth - logoWidth - rightMargin;
                
                doc.addImage(fixedLogoData, 'JPEG', logoX, 10, logoWidth, logoHeight);
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text("", pageWidth - rightMargin - 30, 10 + logoHeight + 5, { align: "right" });
                
                return Math.max(startY, logoHeight + 20);
            } catch (e) {
                console.error("Erro ao adicionar logo fixa:", e);
                return startY;
            }
        }

        function formatarRazaoSocialParaPDF(razaoSocial) {
            if (!razaoSocial || razaoSocial.length <= 25) {
                return razaoSocial;
            }
            
            const palavras = razaoSocial.split(' ');
            
            if (palavras.length < 3) {
                const meio = Math.floor(razaoSocial.length / 2);
                return razaoSocial.substring(0, meio) + '\n' + razaoSocial.substring(meio);
            }
            
            let primeiraLinha = palavras[0] + ' ' + palavras[1];
            let segundaLinha = palavras.slice(2).join(' ');
            
            if (primeiraLinha.length > 25) {
                primeiraLinha = palavras[0];
                segundaLinha = palavras.slice(1).join(' ');
            }
            
            if (segundaLinha.length > 30) {
                const meio = Math.floor(segundaLinha.length / 2);
                const parte1 = segundaLinha.substring(0, meio);
                const parte2 = segundaLinha.substring(meio);
                
                const ultimoEspaco = parte1.lastIndexOf(' ');
                if (ultimoEspaco !== -1) {
                    segundaLinha = parte1.substring(0, ultimoEspaco) + '\n' + parte1.substring(ultimoEspaco + 1) + parte2;
                } else {
                    segundaLinha = parte1 + '\n' + parte2;
                }
                
                return primeiraLinha + '\n' + segundaLinha;
            }
            
            return primeiraLinha + '\n' + segundaLinha;
        }

        function drawSignatures(doc, startY, assinatura, clienteInfo, contadorInfo) {
            const pageWidth = doc.internal.pageSize.width;
            const center = pageWidth / 2;
            const left = 30;
            const right = pageWidth - 100;
            const lineLength = 70;

            const drawCliente = (x, y) => {
                doc.line(x, y, x + lineLength, y);
            
                doc.setFontSize(12);
                doc.setFont("helvetica", 'bold');
            
                let nomePrincipal;
                let documentoPrincipal;

                if (clienteInfo.razaoSocial && clienteInfo.razaoSocial !== "EMPRESA NÃO INFORMADA") {
                    nomePrincipal = formatarRazaoSocialParaPDF(clienteInfo.razaoSocial);
                    documentoPrincipal = `CNPJ: ${clienteInfo.cnpj}`;
                } else {
                    nomePrincipal = clienteInfo.repNome;
                    documentoPrincipal = `CPF: ${clienteInfo.repCpf}`;
                }

                const nomeLinhas = nomePrincipal.split('\n');
                let currentY = y + 5;
                
                nomeLinhas.forEach(linha => {
                    doc.text(linha.toUpperCase(), x + lineLength / 2, currentY, { align: 'center' });
                    currentY += 5;
                });

                doc.setFont("helvetica", 'normal');
                doc.setFontSize(10);
                doc.text(documentoPrincipal, x + lineLength / 2, currentY, { align: 'center' });
                doc.setFontSize(12);
            };

            const drawContador = (x, y) => {
                doc.line(x, y, x + lineLength, y);

                doc.setFont("helvetica", 'bold');
                doc.text(contadorInfo.nome.toUpperCase(), x + lineLength / 2, y + 5, { align: 'center' });

                doc.setFont("helvetica", 'normal');
                doc.setFontSize(10);
                doc.text(contadorInfo.crc, x + lineLength / 2, y + 10, { align: 'center' });

                if (contadorInfo.crcEstados) {
                    doc.text(contadorInfo.crcEstados, x + lineLength / 2, y + 15, { align: 'center' });
                }
                doc.setFontSize(12);
            };

            const signatureBaseY = startY + 10; 

            if (assinatura === 'Cliente') {
                drawCliente(center - lineLength / 2, signatureBaseY);
            } else if (assinatura === 'Contador') {
                drawContador(center - lineLength / 2, signatureBaseY);
            } else if (assinatura === 'Ambos') {
                drawCliente(left, startY + 10); 
                drawContador(right, startY + 30); 
            }
        }

        function getCommonData(aba) {
            const abaMap = { '1': 'real', '2': 'sim', '3': 'nao', '4': 'prev' };
            const tipoAba = abaMap[aba];

            const empresaDiv = document.getElementById(`dadosEmpresa${aba}`);
            const clienteInfo = {
                razaoSocial: empresaDiv.dataset.razaoSocial || "",
                endereco: empresaDiv.dataset.endereco || "",
                cnpj: document.getElementById(`cnpj${aba}`).value,
                repNome: document.getElementById(`repNome${aba}`).value,
                repCpf: document.getElementById(`repCpf${aba}`).value
            };

            let representanteTexto = "";
            if (!document.getElementById(`rep-${tipoAba}`).classList.contains("hidden") && clienteInfo.repNome) {
                const partes = [
                    clienteInfo.repNome,
                    document.getElementById(`repNacionalidade${aba}`).value,
                    document.getElementById(`repEstadoCivil${aba}`).value,
                    document.getElementById(`repProfissao${aba}`).value
                ];
            
                if (document.getElementById(`repDataNascimento${aba}`).value) {
                    partes.splice(2, 0, `nascido(a) em ${document.getElementById(`repDataNascimento${aba}`).value}`);
                }

                let texto = partes.filter(p => p).join(', ');

                if (document.getElementById(`repRg${aba}`).value) texto += `, portador da Cédula de Identidade ${document.getElementById(`repRg${aba}`).value}`;
                if (clienteInfo.repCpf) texto += `, inscrito no CPF sob o n° ${clienteInfo.repCpf}`;
                if (document.getElementById(`repEndereco${aba}`).value) texto += `, residente e domiciliado em ${document.getElementById(`repEndereco${aba}`).value}`;

                representanteTexto = `, neste ato representada por ${texto}`;
            }

            const contadorInfo = {
                nome: document.getElementById(`nomeContador${aba}`).innerText,
                crc: document.getElementById(`crcContador${aba}`).innerText,
                crcEstados: document.getElementById(`crcEstados${aba}`).innerText
            };

            return { clienteInfo, representanteTexto, contadorInfo };
        }
    
        function gerarPDF(aba, titulo, fraseDeclaracao, isPrevisao = false) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = getCommonData(aba);

            let startY = 20;
            startY = addFixedLogoToPDF(doc, startY);

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text("À", 10, startY);
            doc.text("Quem possa interessar", 10, startY + 10);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text(titulo, 105, startY + 20, { align: "center" });
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");

            const razaoSocialFormatada = formatarRazaoSocialParaPDF(data.clienteInfo.razaoSocial || "NOME DA EMPRESA NÃO ENCONTRADO");
            
            let frase = fraseDeclaracao
                .replace('{razaoSocial}', razaoSocialFormatada)
                .replace('{cnpj}', data.clienteInfo.cnpj)
                .replace('{endereco}', data.clienteInfo.endereco)
                .replace('{representante}', data.representanteTexto);

            const lines = doc.splitTextToSize(frase, doc.internal.pageSize.width - 20);
            let currentY = startY + 35;
            
            if (lines.length > 0) {
                drawFormattedText(doc, lines[0], 15, currentY, doc.internal.pageSize.width - 25);
                currentY += 5;
            }
            
            for (let i = 1; i < lines.length; i++) {
                drawFormattedText(doc, lines[i], 10, currentY, doc.internal.pageSize.width - 20);
                currentY += 5;
            }
            
            let finalY = currentY;

            if (aba !== '3') {
                let valores = [];
                let soma = 0;
                document.querySelectorAll(`#tabela${aba} tbody tr:not(.total-row)`).forEach(tr => {
                    const mes = tr.children[0].innerText;
                    const valor = tr.children[1].querySelector("input").value || "R$ 0,00";
                    valores.push([mes, valor]);
                    soma += parseMoeda(valor);
                });

                valores.push(['TOTAL:', soma.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })]);
    
                if (typeof doc.autoTable !== 'undefined') {
                    const alturaTabela = (valores.length + 1) * 10; 

                    if (finalY + alturaTabela > doc.internal.pageSize.height) {
                        doc.addPage();
                        finalY = 20; 
                    }

                    doc.autoTable({
                        head: [['Mês/Ano', 'Valores']],
                        body: valores,
                        startY: finalY + 5,
                        margin: { left: (doc.internal.pageSize.width - 100) / 2 },
                        tableWidth: 100,
                        styles: {
                            fontSize: 10,
                            cellPadding: 1, 
                            valign: 'middle',
                            halign: 'center'
                        },
                        headStyles: {
                            fillColor: [0, 86, 179],
                            textColor: 255,
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        bodyStyles: {
                            textColor: [0, 0, 0],
                            halign: 'center'
                        },
                        alternateRowStyles: {
                            fillColor: [240, 240, 240]
                        },
                        rowHeight: 2, 
                        didParseCell: function(data) {
                            if (data.section === 'head') {
                                data.cell.styles.minCellHeight = 5;
                            }

                            if (data.row.index === valores.length - 1) {
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.fillColor = [217, 225, 242];
                                data.cell.styles.minCellHeight = 5;
                            }    
                        }
                    });
                    
                    finalY = doc.lastAutoTable.finalY + 5;
                } else {
                    console.error("jsPDF-autotable não foi carregado corretamente.");
                    alert("Erro ao gerar PDF: A biblioteca de tabelas não foi encontrada. Tente recarregar a página.");
                    return;
                }
            }

            const alturaNecessaria = 50;

            if (finalY + alturaNecessaria > doc.internal.pageSize.height) {
                doc.addPage();
                finalY = 20;
            }

            let hoje = new Date();
            let dataLocal = `Palmas (TO), ${hoje.getDate()} de ${hoje.toLocaleString("pt-BR", { month: "long" })} de ${hoje.getFullYear()}`;
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0, 0, 0);
            doc.text(dataLocal, doc.internal.pageSize.width - 10, finalY + 10, { align: "right" });
            
            doc.text("Por ser verdade, firmamos o presente sob as penas da lei.", 10, finalY + 20);

            const assinatura = document.getElementById(`assinatura${aba}`).value;
            drawSignatures(doc, finalY + 35, assinatura, data.clienteInfo, data.contadorInfo);

            const nomeArquivo = titulo.replace(/ /g, '_') + '.pdf';
            doc.save(nomeArquivo);
        }

        function gerarPDF1() {
            const inicio = document.getElementById("inicio1").value;
            const fim = document.getElementById("fim1").value;
            const frase = `A empresa **{razaoSocial}**, inscrita no CNPJ sob o n° ${document.getElementById('cnpj1').value}, com sede em ${document.getElementById('dadosEmpresa1').dataset.endereco}{representante}, declara por meio deste o faturamento no período de  **${formatarPeriodo(inicio)}** até **${formatarPeriodo(fim)}** conforme descriminado abaixo:`;
            gerarPDF('1', 'RELAÇÃO DE FATURAMENTO', frase);
        }

        function gerarPDF2() {
            const inicio = document.getElementById("inicio2").value;
            const fim = document.getElementById("fim2").value;
            const frase = `A empresa **{razaoSocial}**, inscrita no CNPJ sob o n° ${document.getElementById('cnpj2').value}, com sede em ${document.getElementById('dadosEmpresa2').dataset.endereco}{representante}, declara por meio deste o faturamento no período de  **${formatarPeriodo(inicio)}** até **${formatarPeriodo(fim)}** conforme descriminado abaixo:`;
            gerarPDF('2', 'RELAÇÃO DE FATURAMENTO', frase);
        }

        function gerarPDF3() {
            const inicio = document.getElementById("inicio3").value;
            const fim = document.getElementById("fim3").value;
            const frase = `A empresa **{razaoSocial}**, inscrita no CNPJ sob no n° ${document.getElementById('cnpj3').value}, com sede em ${document.getElementById('dadosEmpresa3').dataset.endereco}{representante}, declara por meio deste que no período de  **${formatarPeriodo(inicio)}** até **${formatarPeriodo(fim)}** não houve faturamento.`;
            gerarPDF('3', 'DECLARAÇÃO DE NÃO FATURAMENTO', frase);
        }

        function gerarPDF4() {
            const inicio = document.getElementById("inicio4").value;
            const fim = document.getElementById("fim4").value;
            const frase = `A empresa **{razaoSocial}**, inscrita no CNPJ sob o n° ${document.getElementById('cnpj4').value}, com sede em ${document.getElementById('dadosEmpresa4').dataset.endereco}{representante}, declara por meio deste a previsão de faturamento no período de  **${formatarPeriodo(inicio)}** até **${formatarPeriodo(fim)}** conforme descriminado abaixo:`;
            gerarPDF('4', 'PREVISÃO DE FATURA', frase, true);
        }

        window.onload = function() {
            configurarCalculo();
            ['1', '2', '3', '4'].forEach(aba => {
                atualizarResumoAssinatura(aba);
                atualizarResumoRepresentante(aba);
                atualizarResumoCNPJ(aba);
                atualizarResumoPeriodo(aba);
            });
        };
    </script>
</body>
</html>

